<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <!--
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>:)</title>
    <style>
      html,body {
        height: 100%;
      }

      img {
        max-width: 100%;
        max-height: 100%;
        margin: auto;
      }

      button * {
        pointer-events: none;
      }
    </style>
    <link href="/styles/system.css" rel="stylesheet">
    <script>
      const parameters = new URLSearchParams(window.location.search)
      const world = parameters.get('world')
      window.plan98 = {
        host: world ? world : window.location.host
      }

      document.write(`<link href="/cdn/${window.plan98.host}/default.css" rel="stylesheet">`)
    </script>
    <script type="importmap">
      {
        "imports": {
          "@sillonious/module": "/module.js",
          "diffhtml": "https://esm.sh/diffhtml@1.0.0-beta.30",
          "aframe": "https://esm.sh/aframe@1.5.0",
          "react": "https://esm.sh/react@18.2.0",
          "react-dom": "https://esm.sh/react-dom@18.2.0"
        }
      }
    </script>
  </head>
  <body>
    <script src="/package.2015.js"></script>
    <script>
      function modules({ folder }) {
        const tags = new Set(
          [...document.querySelectorAll(':not(:defined)')]
            .map(({ tagName }) => tagName.toLowerCase())
        )

        tags.forEach(async (tag) => {
          const url = `${folder || '.'}/${tag}.js`
          const exists = (await fetch(url, { method: 'HEAD' })).ok
          if(!exists) return
          let definable = true
          await import(url).catch(() => { definable = false })
          try {
            definable = definable && document.querySelector(tag).matches(':not(:defined)')
            if(definable) {
              customElements.define(tag, class WebComponent extends HTMLElement {
                constructor() {
                  super();
                }
              });
            }
          } catch(e) {
            console.log('Error caught establishing formula for:', tag, e)
          }
        })
      }

      (function({ folder }) {
        modules({ folder })
        new MutationObserver((mutationsList) => {
          modules({ folder })
        }).observe(document.body, { childList: true, subtree: true });
      })({ folder: '/modules' })

      document.body.insertAdjacentHTML('beforeend', `
        <sillonious-brand host="${window.plan98.host}">
          <saga-genesis></saga-genesis>
        </sillonious-brand>
      `)
    </script>
  </body>
</html>
